<div id="map" style="width: 100%; height: 800px;"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
  let map, marker; // global map and marker
  const busId = "جك ٧٨٧٨"
  const socket = io("ws://localhost:5003", {
        transports: ["websocket", "polling"],
        reconnection: true, // Allow automatic reconnections
        reconnectionAttempts: 5, // Limit reconnections
        reconnectionDelay: 2000, // Wait 2s before retrying
  });

  function initMap(latitude, longitude) {
    // initialize map and set view to user's location
    map = L.map("map").setView([latitude, longitude], 20);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    // add marker for user's initial location
    marker = L.marker([latitude, longitude]).addTo(map)
      .bindPopup("You are here")
      .openPopup();
  }

  function updatePosition(position) {
    const { latitude , longitude } = position.coords;
    console.log("Updated Location:", latitude, longitude);

    if (!map) {
      // initialize map on first update
      initMap(latitude, longitude);
    } else {
      // ppdate marker position
      marker.setLatLng([latitude, longitude]);
      map.setView([latitude, longitude], 20);
    }
  }

  // connect to bus socket
  socket.emit('joinBusRoom', { busId , userId: 'user1' });

  // listen for bus location updates
  socket.on("busLocationUpdate", ({ busId, latitude, longitude }) => {
    console.log(`Bus ${busId} is at: ${latitude}, ${longitude}`);
    updateMarker(latitude, longitude);
  });

  if ("geolocation" in navigator) {
    // watch for location changes
    navigator.geolocation.watchPosition(
      updatePosition,
      (error) => console.error("Error tracking location:", error.message),
      {
        enableHighAccuracy: false, // set to false for now to make map smoother and not as precise
        maximumAge: 0, // do not cache location
      }
    );
  } else {
    console.error("Geolocation is not supported by this browser.");
  }
</script>